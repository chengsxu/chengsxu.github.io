{"title":"BusyBox自建根文件系统完善","date":"2023-02-24T03:57:20.018Z","source":"_posts/BusyBox自建根文件系统完善.md","raw":"---\ntitle: BusyBox自建根文件系统完善\ndate: 2023-02-24 11:57:20.018\nupdated: 2023-09-09 17:53:08.022\ncategories: \ntags: \n- linux\n---\nBusyBox自建根文件系统完善\n<!-- more -->\n# 添加根文件系统动态库\n```shell\nmkdir lib\ncd /usr/local/arm/gcc-linaro-4.9.4-2017.01-x86_64_arm-linux-gnueabihf/arm-linux-gnueabihf/libc/lib\ncp *so* *.a ~/rootfs/lib/ -d\n\nrm ~/rootfs/lib/ld-linux-armhf.so.3\ncp ld-linux-armhf.so.3 ~/rootfs/lib/\ncd /usr/local/arm/gcc-linaro-4.9.4-2017.01-x86_64_arm-linux-gnueabihf/arm-linux-gnueabihf/lib\ncp *so* *.a ~/rootfs/lib/ -d\n\nmkdir ~/rootfs/usr/lib\ncd /usr/local/arm/gcc-linaro-4.9.4-2017.01-x86_64_arm-linux-gnueabihf/arm-linux-gnueabihf/libc/usr/lib\ncp *so* *.a ~/rootfs/usr/lib/ -d\ncd ~/rootfs\ndu ./lib ./usr/lib/ -sh\n\nmkdir dev\nmkdir proc\nmkdir mnt\nmkdir sys\nmkdir tmp\nmkdir root\n```\n# uboot NFS挂载\n```shell\nroot=/dev/nfs nfsroot=[<server-ip>:]<root-dir>[,<nfs-options>] ip=<client-ip>:<server-ip>:<gwip>:<netmask>:<hostname>:<device>:<autoconf>:<dns0-ip>:<dns1-ip>\nroot=/dev/nfs nfsroot=192.168.3.138:/home/xcc/nfs/rootfs,proto=tcp rw ip=192.168.3.110:192.168.3.138:192.168.3.1:255.255.255.0::eth0:off\nsetenv bootargs 'console=ttymxc0,115200 root=/dev/nfs nfsroot=192.168.3.138:/home/xcc/nfs/rootfs,proto=tcp rw ip=192.168.3.197:192.168.3.138:192.168.3.1:255.255.255.0::eth0:off'\n```\n\n```shell\nrun loadfdt\nrun loadimage\nbootz 80800000 - 83000000\n\nmkdir -p etc/init.d\n\nnano etc/init.d/rcS\n\nchmod 777 etc/init.d/rcS\n```\n内容\n```shell\n#!/bin/sh\nPATH=/sbin:/bin:/usr/sbin:/usr/bin\nLD_LIBRARY_PATH=$LD_LIBRARY_PATH:/lib:/usr/lib\nrunlevel=S \numask 022\nexport PATH LD_LIBRARY_PATH runlevel\n\n#网络开机自启动设置\nifconfig eth0 up\n#udhcpc -i eth0 \nifconfig eth0 192.168.1.251 netmask 255.255.255.0\nroute add default gw 192.168.1.1\n\nmount -a \nmkdir /dev/pts\nmount -t devpts devpts /dev/pts\n\necho /sbin/mdev > /proc/sys/kernel/hotplug\nmdev -s\n```\n\n\nnano etc/fstab\n```shell\n#<file system> <mount point> <type> <options> <dump> <pass> \nproc /proc proc defaults 0 0 \ntmpfs /tmp tmpfs defaults 0 0 \nsysfs /sys sysfs defaults 0 0\n```\n\nnano etc/inittab\n```shell\n#etc/inittab\n::sysinit:/etc/init.d/rcS\nconsole::askfirst:-/bin/sh\n::restart:/sbin/init\n::ctrlaltdel:/sbin/reboot\n::shutdown:/bin/umount -a -r 7 ::shutdown:/sbin/swapoff -a\n```\n\n# nfs install \n```shell\nsudo apt-get install nfs-kernel-server rpcbind\nsudo vi /etc/exports\nmkdir nfs && chmod 777 nfs\n/home/xcc/nfs *(rw,sync,no_root_squash)\nsudo /etc/init.d/nfs-kernel-server restart\n\nsudo vim /etc/default/nfs-kernel-server\n降低nfs版本，不然内核不能使用挂载\nRPCNFSDCOUNT=\"-V 2 8\"\n```\n\n# tftp\n```shell\nsudo apt-get install xinetd -y\nsudo apt-get install tftp-hpa tftpd-hpa -y\nmkdir tftp && chmod 777 tftp\nsudo vi /etc/default/tftpd-hpa\nsudo vi /etc/xinetd.d/tftp\nserver tftp\n{\n    socket_type = dgram\n    wait = yes\n    disable = no\n    user = root\n    protocol = udp\n    server = /usr/sbin/in.tftpd\n    server_args = -s /home/xcc/tftp -c\n    #log_on_success += PID HOST DURATION\n    #log_on_failure += HOST\n    per_source = 11\n    cps =100 2\n    flags =IPv4\n}\n\nsudo service tftpd-hpa restart\nsudo service xinetd restart\n```\n\n\n# 自建roofs打包\n```shell\ncd rootfs/\ntar -vcjf rootfs.tar.bz2 *\n```\n\n```shell\n#!/bin/bash\n\nbusybox_dir=$HOME/imx6ull/busybox\nkernel_dir=$HOME/imx6ull/kernel\ngcc_lib_root=/opt/gcc-linaro-4.9.4-2017.01-x86_64_arm-linux-gnueabihf/arm-linux-gnueabihf\n\nshare_dir=$HOME/imx6ull/nfs\nrootfs_dir=$share_dir/rootfs\n\ndtb_file=imx6ull-alientek-emmc.dtb\ndevice_ip=192.168.3.109\nnetmask=255.255.255.0\ngw=192.168.3.1\nnfs_server_ip=`ifconfig -a|grep inet|grep -v 127.0.0.1|grep -v inet6|awk '{print $2}'|tr -d \"addr:\"`\n\n# env\nsudo apt update\nsudo apt install cmake gcc wget lsb-core lib32stdc++6 libncurses5-dev build-essential lzop -y\n\nrm $share_dir/* -rf\nrm $busybox_dir -rf\nrm $kernel_dir -rf\nmkdir -p $busybox_dir\nmkdir -p $kernel_dir\nmkdir -p $rootfs_dir\ntar -xvf linux-imx-4.1.15-2.1.0-g3dc0a4b-v2.7.tar.bz2 -C $kernel_dir\ntar -xvf busybox-1.29.0.tar.bz2 -C $busybox_dir\nmv $busybox_dir/busybox-1.29.0/{.,}* $busybox_dir\n\n# build\ncpu_logic_cnt=`cat /proc/cpuinfo | grep \"processor\" | wc -l`\ncd $kernel_dir\nmake ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- distclean\nmake ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- imx_alientek_emmc_defconfig\nmake ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- -j$cpu_logic_cnt\nif [ $? -ne 0 ]; then\n    exit;\nfi\n\ncd $busybox_dir\nmake ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- distclean\nwget http://chengs.run/upload/2023/09/busybox_config -O .config\nmake ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- -j$cpu_logic_cnt\nif [ $? -ne 0 ]; then\n    exit;\nfi\n\n# rootfs\ncd $busybox_dir\nmake ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- CONFIG_PREFIX=$rootfs_dir install\n\ncd $rootfs_dir\nmkdir lib\nmkdir -p usr/lib\nmkdir dev\nmkdir proc\nmkdir mnt\nmkdir sys\nmkdir tmp\nmkdir root\nmkdir -p etc/init.d\n\necho \"#!/bin/sh\nPATH=/sbin:/bin:/usr/sbin:/usr/bin\nLD_LIBRARY_PATH=$LD_LIBRARY_PATH:/lib:/usr/lib\nrunlevel=S \numask 022\nexport PATH LD_LIBRARY_PATH runlevel\n\n#网络开机自启动设置\nifconfig eth0 up\n# udhcpc -i eth0 \n# ifconfig eth0 ${device_ip} netmask ${netmask}\n# route add default gw ${gw}\n\nmount -a \nmkdir /dev/pts\nmount -t devpts devpts /dev/pts\n\necho /sbin/mdev > /proc/sys/kernel/hotplug\nmdev -s\n\" > etc/init.d/rcS\n\nchmod 777 etc/init.d/rcS\n\necho \"#<file system> <mount point> <type> <options> <dump> <pass> \nproc /proc proc defaults 0 0 \ntmpfs /tmp tmpfs defaults 0 0 \nsysfs /sys sysfs defaults 0 0\n\" > etc/fstab\n\necho \"#etc/inittab\n::sysinit:/etc/init.d/rcS\nconsole::askfirst:-/bin/sh\n::restart:/sbin/init\n::ctrlaltdel:/sbin/reboot\n::shutdown:/bin/umount -a -r 7 ::shutdown:/sbin/swapoff -a\n\" > etc/inittab\n\necho \"nameserver 8.8.8.8\nnameserver ${gw}\n\" > etc/resolv.conf\n\n# rootfs lib\ncd $gcc_lib_root/libc/lib\ncp *so* *.a $rootfs_dir/lib/ -d\nrm $rootfs_dir/lib/ld-linux-armhf.so.3\ncp ld-linux-armhf.so.3 $rootfs_dir/lib/\n\ncd $gcc_lib_root/lib\ncp *so* *.a $rootfs_dir/lib/ -d\n\ncd $gcc_lib_root/libc/usr/lib\ncp *so* *.a $rootfs_dir/usr/lib/ -d\n\ncd $rootfs_dir\ndu ./lib ./usr/lib/ -sh\n\n# lib test\necho '''\n#include <stdio.h>\n\nint main(int argc, const char* argv[])\n{\n   printf(\"helloworld\\n\");\n   return 0;\n}\n''' >> main.c\n\narm-linux-gnueabihf-gcc -o main main.c\nmv main $rootfs_dir/root\nrm main.c\n\n# zImage dtb\ncp $kernel_dir/arch/arm/boot/zImage $share_dir\ncp $kernel_dir/arch/arm/boot/dts/$dtb_file $share_dir\n\necho \"\n# uboot setting\nsetenv bootcmd 'nfs 80800000 ${nfs_server_ip}:${share_dir}/zImage;nfs 83000000 ${nfs_server_ip}:${share_dir}/${dtb_file};setenv bootargs console=ttymxc0,115200 root=/dev/nfs nfsroot=${nfs_server_ip}:${rootfs_dir},proto=tcp rw ip=${device_ip}:${nfs_server_ip}:${gw}:${netmask}::eth0:off;bootz 80800000 - 83000000;'\n\"\n```","slug":"BusyBox自建根文件系统完善","published":true,"updated":"2023-09-09T09:53:08.022Z","_id":"cm83396070000i0q60qek8y33","comments":true,"layout":"post","photos":[],"html":"<p>BusyBox自建根文件系统完善</p>\n<span id=\"more\"></span>\n<h1 id=\"添加根文件系统动态库\"><a href=\"#添加根文件系统动态库\" class=\"headerlink\" title=\"添加根文件系统动态库\"></a>添加根文件系统动态库</h1><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir lib</span><br><span class=\"line\">cd /usr/local/arm/gcc-linaro-4.9.4-2017.01-x86_64_arm-linux-gnueabihf/arm-linux-gnueabihf/libc/lib</span><br><span class=\"line\">cp *so* *.a ~/rootfs/lib/ -d</span><br><span class=\"line\"></span><br><span class=\"line\">rm ~/rootfs/lib/ld-linux-armhf.so.3</span><br><span class=\"line\">cp ld-linux-armhf.so.3 ~/rootfs/lib/</span><br><span class=\"line\">cd /usr/local/arm/gcc-linaro-4.9.4-2017.01-x86_64_arm-linux-gnueabihf/arm-linux-gnueabihf/lib</span><br><span class=\"line\">cp *so* *.a ~/rootfs/lib/ -d</span><br><span class=\"line\"></span><br><span class=\"line\">mkdir ~/rootfs/usr/lib</span><br><span class=\"line\">cd /usr/local/arm/gcc-linaro-4.9.4-2017.01-x86_64_arm-linux-gnueabihf/arm-linux-gnueabihf/libc/usr/lib</span><br><span class=\"line\">cp *so* *.a ~/rootfs/usr/lib/ -d</span><br><span class=\"line\">cd ~/rootfs</span><br><span class=\"line\">du ./lib ./usr/lib/ -sh</span><br><span class=\"line\"></span><br><span class=\"line\">mkdir dev</span><br><span class=\"line\">mkdir proc</span><br><span class=\"line\">mkdir mnt</span><br><span class=\"line\">mkdir sys</span><br><span class=\"line\">mkdir tmp</span><br><span class=\"line\">mkdir root</span><br></pre></td></tr></table></figure>\n<h1 id=\"uboot-NFS挂载\"><a href=\"#uboot-NFS挂载\" class=\"headerlink\" title=\"uboot NFS挂载\"></a>uboot NFS挂载</h1><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root=/dev/nfs nfsroot=[&lt;server-ip&gt;:]&lt;root-dir&gt;[,&lt;nfs-options&gt;] ip=&lt;client-ip&gt;:&lt;server-ip&gt;:&lt;gwip&gt;:&lt;netmask&gt;:&lt;hostname&gt;:&lt;device&gt;:&lt;autoconf&gt;:&lt;dns0-ip&gt;:&lt;dns1-ip&gt;</span><br><span class=\"line\">root=/dev/nfs nfsroot=192.168.3.138:/home/xcc/nfs/rootfs,proto=tcp rw ip=192.168.3.110:192.168.3.138:192.168.3.1:255.255.255.0::eth0:off</span><br><span class=\"line\">setenv bootargs &#x27;console=ttymxc0,115200 root=/dev/nfs nfsroot=192.168.3.138:/home/xcc/nfs/rootfs,proto=tcp rw ip=192.168.3.197:192.168.3.138:192.168.3.1:255.255.255.0::eth0:off&#x27;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">run loadfdt</span><br><span class=\"line\">run loadimage</span><br><span class=\"line\">bootz 80800000 - 83000000</span><br><span class=\"line\"></span><br><span class=\"line\">mkdir -p etc/init.d</span><br><span class=\"line\"></span><br><span class=\"line\">nano etc/init.d/rcS</span><br><span class=\"line\"></span><br><span class=\"line\">chmod 777 etc/init.d/rcS</span><br></pre></td></tr></table></figure>\n<p>内容</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span></span><br><span class=\"line\">PATH=/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class=\"line\">LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/lib:/usr/lib</span><br><span class=\"line\">runlevel=S </span><br><span class=\"line\">umask 022</span><br><span class=\"line\">export PATH LD_LIBRARY_PATH runlevel</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">网络开机自启动设置</span></span><br><span class=\"line\">ifconfig eth0 up</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">udhcpc -i eth0</span> </span><br><span class=\"line\">ifconfig eth0 192.168.1.251 netmask 255.255.255.0</span><br><span class=\"line\">route add default gw 192.168.1.1</span><br><span class=\"line\"></span><br><span class=\"line\">mount -a </span><br><span class=\"line\">mkdir /dev/pts</span><br><span class=\"line\">mount -t devpts devpts /dev/pts</span><br><span class=\"line\"></span><br><span class=\"line\">echo /sbin/mdev &gt; /proc/sys/kernel/hotplug</span><br><span class=\"line\">mdev -s</span><br></pre></td></tr></table></figure>\n\n\n<p>nano etc&#x2F;fstab</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">&lt;file system&gt; &lt;mount point&gt; &lt;<span class=\"built_in\">type</span>&gt; &lt;options&gt; &lt;dump&gt; &lt;pass&gt;</span> </span><br><span class=\"line\">proc /proc proc defaults 0 0 </span><br><span class=\"line\">tmpfs /tmp tmpfs defaults 0 0 </span><br><span class=\"line\">sysfs /sys sysfs defaults 0 0</span><br></pre></td></tr></table></figure>\n\n<p>nano etc&#x2F;inittab</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">etc/inittab</span></span><br><span class=\"line\">::sysinit:/etc/init.d/rcS</span><br><span class=\"line\">console::askfirst:-/bin/sh</span><br><span class=\"line\">::restart:/sbin/init</span><br><span class=\"line\">::ctrlaltdel:/sbin/reboot</span><br><span class=\"line\">::shutdown:/bin/umount -a -r 7 ::shutdown:/sbin/swapoff -a</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"nfs-install\"><a href=\"#nfs-install\" class=\"headerlink\" title=\"nfs install\"></a>nfs install</h1><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo apt-get install nfs-kernel-server rpcbind</span><br><span class=\"line\">sudo vi /etc/exports</span><br><span class=\"line\">mkdir nfs &amp;&amp; chmod 777 nfs</span><br><span class=\"line\">/home/xcc/nfs *(rw,sync,no_root_squash)</span><br><span class=\"line\">sudo /etc/init.d/nfs-kernel-server restart</span><br><span class=\"line\"></span><br><span class=\"line\">sudo vim /etc/default/nfs-kernel-server</span><br><span class=\"line\">降低nfs版本，不然内核不能使用挂载</span><br><span class=\"line\">RPCNFSDCOUNT=&quot;-V 2 8&quot;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"tftp\"><a href=\"#tftp\" class=\"headerlink\" title=\"tftp\"></a>tftp</h1><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo apt-get install xinetd -y</span><br><span class=\"line\">sudo apt-get install tftp-hpa tftpd-hpa -y</span><br><span class=\"line\">mkdir tftp &amp;&amp; chmod 777 tftp</span><br><span class=\"line\">sudo vi /etc/default/tftpd-hpa</span><br><span class=\"line\">sudo vi /etc/xinetd.d/tftp</span><br><span class=\"line\">server tftp</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    socket_type = dgram</span><br><span class=\"line\">    wait = yes</span><br><span class=\"line\">    disable = no</span><br><span class=\"line\">    user = root</span><br><span class=\"line\">    protocol = udp</span><br><span class=\"line\">    server = /usr/sbin/in.tftpd</span><br><span class=\"line\">    server_args = -s /home/xcc/tftp -c</span><br><span class=\"line\">    #log_on_success += PID HOST DURATION</span><br><span class=\"line\">    #log_on_failure += HOST</span><br><span class=\"line\">    per_source = 11</span><br><span class=\"line\">    cps =100 2</span><br><span class=\"line\">    flags =IPv4</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">sudo service tftpd-hpa restart</span><br><span class=\"line\">sudo service xinetd restart</span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"自建roofs打包\"><a href=\"#自建roofs打包\" class=\"headerlink\" title=\"自建roofs打包\"></a>自建roofs打包</h1><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd rootfs/</span><br><span class=\"line\">tar -vcjf rootfs.tar.bz2 *</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\">busybox_dir=$HOME/imx6ull/busybox</span><br><span class=\"line\">kernel_dir=$HOME/imx6ull/kernel</span><br><span class=\"line\">gcc_lib_root=/opt/gcc-linaro-4.9.4-2017.01-x86_64_arm-linux-gnueabihf/arm-linux-gnueabihf</span><br><span class=\"line\"></span><br><span class=\"line\">share_dir=$HOME/imx6ull/nfs</span><br><span class=\"line\">rootfs_dir=$share_dir/rootfs</span><br><span class=\"line\"></span><br><span class=\"line\">dtb_file=imx6ull-alientek-emmc.dtb</span><br><span class=\"line\">device_ip=192.168.3.109</span><br><span class=\"line\">netmask=255.255.255.0</span><br><span class=\"line\">gw=192.168.3.1</span><br><span class=\"line\">nfs_server_ip=`ifconfig -a|grep inet|grep -v 127.0.0.1|grep -v inet6|awk &#x27;&#123;print $2&#125;&#x27;|tr -d &quot;addr:&quot;`</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"built_in\">env</span></span></span><br><span class=\"line\">sudo apt update</span><br><span class=\"line\">sudo apt install cmake gcc wget lsb-core lib32stdc++6 libncurses5-dev build-essential lzop -y</span><br><span class=\"line\"></span><br><span class=\"line\">rm $share_dir/* -rf</span><br><span class=\"line\">rm $busybox_dir -rf</span><br><span class=\"line\">rm $kernel_dir -rf</span><br><span class=\"line\">mkdir -p $busybox_dir</span><br><span class=\"line\">mkdir -p $kernel_dir</span><br><span class=\"line\">mkdir -p $rootfs_dir</span><br><span class=\"line\">tar -xvf linux-imx-4.1.15-2.1.0-g3dc0a4b-v2.7.tar.bz2 -C $kernel_dir</span><br><span class=\"line\">tar -xvf busybox-1.29.0.tar.bz2 -C $busybox_dir</span><br><span class=\"line\">mv $busybox_dir/busybox-1.29.0/&#123;.,&#125;* $busybox_dir</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">build</span></span><br><span class=\"line\">cpu_logic_cnt=`cat /proc/cpuinfo | grep &quot;processor&quot; | wc -l`</span><br><span class=\"line\">cd $kernel_dir</span><br><span class=\"line\">make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- distclean</span><br><span class=\"line\">make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- imx_alientek_emmc_defconfig</span><br><span class=\"line\">make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- -j$cpu_logic_cnt</span><br><span class=\"line\">if [ $? -ne 0 ]; then</span><br><span class=\"line\">    exit;</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\">cd $busybox_dir</span><br><span class=\"line\">make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- distclean</span><br><span class=\"line\">wget http://chengs.run/upload/2023/09/busybox_config -O .config</span><br><span class=\"line\">make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- -j$cpu_logic_cnt</span><br><span class=\"line\">if [ $? -ne 0 ]; then</span><br><span class=\"line\">    exit;</span><br><span class=\"line\">fi</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">rootfs</span></span><br><span class=\"line\">cd $busybox_dir</span><br><span class=\"line\">make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- CONFIG_PREFIX=$rootfs_dir install</span><br><span class=\"line\"></span><br><span class=\"line\">cd $rootfs_dir</span><br><span class=\"line\">mkdir lib</span><br><span class=\"line\">mkdir -p usr/lib</span><br><span class=\"line\">mkdir dev</span><br><span class=\"line\">mkdir proc</span><br><span class=\"line\">mkdir mnt</span><br><span class=\"line\">mkdir sys</span><br><span class=\"line\">mkdir tmp</span><br><span class=\"line\">mkdir root</span><br><span class=\"line\">mkdir -p etc/init.d</span><br><span class=\"line\"></span><br><span class=\"line\">echo &quot;#!/bin/sh</span><br><span class=\"line\">PATH=/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class=\"line\">LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/lib:/usr/lib</span><br><span class=\"line\">runlevel=S </span><br><span class=\"line\">umask 022</span><br><span class=\"line\">export PATH LD_LIBRARY_PATH runlevel</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">网络开机自启动设置</span></span><br><span class=\"line\">ifconfig eth0 up</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">udhcpc -i eth0</span> </span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ifconfig eth0 <span class=\"variable\">$&#123;device_ip&#125;</span> netmask <span class=\"variable\">$&#123;netmask&#125;</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">route add default gw <span class=\"variable\">$&#123;gw&#125;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\">mount -a </span><br><span class=\"line\">mkdir /dev/pts</span><br><span class=\"line\">mount -t devpts devpts /dev/pts</span><br><span class=\"line\"></span><br><span class=\"line\">echo /sbin/mdev &gt; /proc/sys/kernel/hotplug</span><br><span class=\"line\">mdev -s</span><br><span class=\"line\">&quot; &gt; etc/init.d/rcS</span><br><span class=\"line\"></span><br><span class=\"line\">chmod 777 etc/init.d/rcS</span><br><span class=\"line\"></span><br><span class=\"line\">echo &quot;#&lt;file system&gt; &lt;mount point&gt; &lt;type&gt; &lt;options&gt; &lt;dump&gt; &lt;pass&gt; </span><br><span class=\"line\">proc /proc proc defaults 0 0 </span><br><span class=\"line\">tmpfs /tmp tmpfs defaults 0 0 </span><br><span class=\"line\">sysfs /sys sysfs defaults 0 0</span><br><span class=\"line\">&quot; &gt; etc/fstab</span><br><span class=\"line\"></span><br><span class=\"line\">echo &quot;#etc/inittab</span><br><span class=\"line\">::sysinit:/etc/init.d/rcS</span><br><span class=\"line\">console::askfirst:-/bin/sh</span><br><span class=\"line\">::restart:/sbin/init</span><br><span class=\"line\">::ctrlaltdel:/sbin/reboot</span><br><span class=\"line\">::shutdown:/bin/umount -a -r 7 ::shutdown:/sbin/swapoff -a</span><br><span class=\"line\">&quot; &gt; etc/inittab</span><br><span class=\"line\"></span><br><span class=\"line\">echo &quot;nameserver 8.8.8.8</span><br><span class=\"line\">nameserver $&#123;gw&#125;</span><br><span class=\"line\">&quot; &gt; etc/resolv.conf</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">rootfs lib</span></span><br><span class=\"line\">cd $gcc_lib_root/libc/lib</span><br><span class=\"line\">cp *so* *.a $rootfs_dir/lib/ -d</span><br><span class=\"line\">rm $rootfs_dir/lib/ld-linux-armhf.so.3</span><br><span class=\"line\">cp ld-linux-armhf.so.3 $rootfs_dir/lib/</span><br><span class=\"line\"></span><br><span class=\"line\">cd $gcc_lib_root/lib</span><br><span class=\"line\">cp *so* *.a $rootfs_dir/lib/ -d</span><br><span class=\"line\"></span><br><span class=\"line\">cd $gcc_lib_root/libc/usr/lib</span><br><span class=\"line\">cp *so* *.a $rootfs_dir/usr/lib/ -d</span><br><span class=\"line\"></span><br><span class=\"line\">cd $rootfs_dir</span><br><span class=\"line\">du ./lib ./usr/lib/ -sh</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">lib <span class=\"built_in\">test</span></span></span><br><span class=\"line\">echo &#x27;&#x27;&#x27;</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">include &lt;stdio.h&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, const char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">   printf(&quot;helloworld\\n&quot;);</span><br><span class=\"line\">   return 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#x27;&#x27;&#x27; &gt;&gt; main.c</span><br><span class=\"line\"></span><br><span class=\"line\">arm-linux-gnueabihf-gcc -o main main.c</span><br><span class=\"line\">mv main $rootfs_dir/root</span><br><span class=\"line\">rm main.c</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">zImage dtb</span></span><br><span class=\"line\">cp $kernel_dir/arch/arm/boot/zImage $share_dir</span><br><span class=\"line\">cp $kernel_dir/arch/arm/boot/dts/$dtb_file $share_dir</span><br><span class=\"line\"></span><br><span class=\"line\">echo &quot;</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">uboot setting</span></span><br><span class=\"line\">setenv bootcmd &#x27;nfs 80800000 $&#123;nfs_server_ip&#125;:$&#123;share_dir&#125;/zImage;nfs 83000000 $&#123;nfs_server_ip&#125;:$&#123;share_dir&#125;/$&#123;dtb_file&#125;;setenv bootargs console=ttymxc0,115200 root=/dev/nfs nfsroot=$&#123;nfs_server_ip&#125;:$&#123;rootfs_dir&#125;,proto=tcp rw ip=$&#123;device_ip&#125;:$&#123;nfs_server_ip&#125;:$&#123;gw&#125;:$&#123;netmask&#125;::eth0:off;bootz 80800000 - 83000000;&#x27;</span><br><span class=\"line\">&quot;</span><br></pre></td></tr></table></figure>","excerpt":"<p>BusyBox自建根文件系统完善</p>","more":"<h1 id=\"添加根文件系统动态库\"><a href=\"#添加根文件系统动态库\" class=\"headerlink\" title=\"添加根文件系统动态库\"></a>添加根文件系统动态库</h1><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir lib</span><br><span class=\"line\">cd /usr/local/arm/gcc-linaro-4.9.4-2017.01-x86_64_arm-linux-gnueabihf/arm-linux-gnueabihf/libc/lib</span><br><span class=\"line\">cp *so* *.a ~/rootfs/lib/ -d</span><br><span class=\"line\"></span><br><span class=\"line\">rm ~/rootfs/lib/ld-linux-armhf.so.3</span><br><span class=\"line\">cp ld-linux-armhf.so.3 ~/rootfs/lib/</span><br><span class=\"line\">cd /usr/local/arm/gcc-linaro-4.9.4-2017.01-x86_64_arm-linux-gnueabihf/arm-linux-gnueabihf/lib</span><br><span class=\"line\">cp *so* *.a ~/rootfs/lib/ -d</span><br><span class=\"line\"></span><br><span class=\"line\">mkdir ~/rootfs/usr/lib</span><br><span class=\"line\">cd /usr/local/arm/gcc-linaro-4.9.4-2017.01-x86_64_arm-linux-gnueabihf/arm-linux-gnueabihf/libc/usr/lib</span><br><span class=\"line\">cp *so* *.a ~/rootfs/usr/lib/ -d</span><br><span class=\"line\">cd ~/rootfs</span><br><span class=\"line\">du ./lib ./usr/lib/ -sh</span><br><span class=\"line\"></span><br><span class=\"line\">mkdir dev</span><br><span class=\"line\">mkdir proc</span><br><span class=\"line\">mkdir mnt</span><br><span class=\"line\">mkdir sys</span><br><span class=\"line\">mkdir tmp</span><br><span class=\"line\">mkdir root</span><br></pre></td></tr></table></figure>\n<h1 id=\"uboot-NFS挂载\"><a href=\"#uboot-NFS挂载\" class=\"headerlink\" title=\"uboot NFS挂载\"></a>uboot NFS挂载</h1><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root=/dev/nfs nfsroot=[&lt;server-ip&gt;:]&lt;root-dir&gt;[,&lt;nfs-options&gt;] ip=&lt;client-ip&gt;:&lt;server-ip&gt;:&lt;gwip&gt;:&lt;netmask&gt;:&lt;hostname&gt;:&lt;device&gt;:&lt;autoconf&gt;:&lt;dns0-ip&gt;:&lt;dns1-ip&gt;</span><br><span class=\"line\">root=/dev/nfs nfsroot=192.168.3.138:/home/xcc/nfs/rootfs,proto=tcp rw ip=192.168.3.110:192.168.3.138:192.168.3.1:255.255.255.0::eth0:off</span><br><span class=\"line\">setenv bootargs &#x27;console=ttymxc0,115200 root=/dev/nfs nfsroot=192.168.3.138:/home/xcc/nfs/rootfs,proto=tcp rw ip=192.168.3.197:192.168.3.138:192.168.3.1:255.255.255.0::eth0:off&#x27;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">run loadfdt</span><br><span class=\"line\">run loadimage</span><br><span class=\"line\">bootz 80800000 - 83000000</span><br><span class=\"line\"></span><br><span class=\"line\">mkdir -p etc/init.d</span><br><span class=\"line\"></span><br><span class=\"line\">nano etc/init.d/rcS</span><br><span class=\"line\"></span><br><span class=\"line\">chmod 777 etc/init.d/rcS</span><br></pre></td></tr></table></figure>\n<p>内容</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span></span><br><span class=\"line\">PATH=/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class=\"line\">LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/lib:/usr/lib</span><br><span class=\"line\">runlevel=S </span><br><span class=\"line\">umask 022</span><br><span class=\"line\">export PATH LD_LIBRARY_PATH runlevel</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">网络开机自启动设置</span></span><br><span class=\"line\">ifconfig eth0 up</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">udhcpc -i eth0</span> </span><br><span class=\"line\">ifconfig eth0 192.168.1.251 netmask 255.255.255.0</span><br><span class=\"line\">route add default gw 192.168.1.1</span><br><span class=\"line\"></span><br><span class=\"line\">mount -a </span><br><span class=\"line\">mkdir /dev/pts</span><br><span class=\"line\">mount -t devpts devpts /dev/pts</span><br><span class=\"line\"></span><br><span class=\"line\">echo /sbin/mdev &gt; /proc/sys/kernel/hotplug</span><br><span class=\"line\">mdev -s</span><br></pre></td></tr></table></figure>\n\n\n<p>nano etc&#x2F;fstab</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">&lt;file system&gt; &lt;mount point&gt; &lt;<span class=\"built_in\">type</span>&gt; &lt;options&gt; &lt;dump&gt; &lt;pass&gt;</span> </span><br><span class=\"line\">proc /proc proc defaults 0 0 </span><br><span class=\"line\">tmpfs /tmp tmpfs defaults 0 0 </span><br><span class=\"line\">sysfs /sys sysfs defaults 0 0</span><br></pre></td></tr></table></figure>\n\n<p>nano etc&#x2F;inittab</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">etc/inittab</span></span><br><span class=\"line\">::sysinit:/etc/init.d/rcS</span><br><span class=\"line\">console::askfirst:-/bin/sh</span><br><span class=\"line\">::restart:/sbin/init</span><br><span class=\"line\">::ctrlaltdel:/sbin/reboot</span><br><span class=\"line\">::shutdown:/bin/umount -a -r 7 ::shutdown:/sbin/swapoff -a</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"nfs-install\"><a href=\"#nfs-install\" class=\"headerlink\" title=\"nfs install\"></a>nfs install</h1><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo apt-get install nfs-kernel-server rpcbind</span><br><span class=\"line\">sudo vi /etc/exports</span><br><span class=\"line\">mkdir nfs &amp;&amp; chmod 777 nfs</span><br><span class=\"line\">/home/xcc/nfs *(rw,sync,no_root_squash)</span><br><span class=\"line\">sudo /etc/init.d/nfs-kernel-server restart</span><br><span class=\"line\"></span><br><span class=\"line\">sudo vim /etc/default/nfs-kernel-server</span><br><span class=\"line\">降低nfs版本，不然内核不能使用挂载</span><br><span class=\"line\">RPCNFSDCOUNT=&quot;-V 2 8&quot;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"tftp\"><a href=\"#tftp\" class=\"headerlink\" title=\"tftp\"></a>tftp</h1><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo apt-get install xinetd -y</span><br><span class=\"line\">sudo apt-get install tftp-hpa tftpd-hpa -y</span><br><span class=\"line\">mkdir tftp &amp;&amp; chmod 777 tftp</span><br><span class=\"line\">sudo vi /etc/default/tftpd-hpa</span><br><span class=\"line\">sudo vi /etc/xinetd.d/tftp</span><br><span class=\"line\">server tftp</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    socket_type = dgram</span><br><span class=\"line\">    wait = yes</span><br><span class=\"line\">    disable = no</span><br><span class=\"line\">    user = root</span><br><span class=\"line\">    protocol = udp</span><br><span class=\"line\">    server = /usr/sbin/in.tftpd</span><br><span class=\"line\">    server_args = -s /home/xcc/tftp -c</span><br><span class=\"line\">    #log_on_success += PID HOST DURATION</span><br><span class=\"line\">    #log_on_failure += HOST</span><br><span class=\"line\">    per_source = 11</span><br><span class=\"line\">    cps =100 2</span><br><span class=\"line\">    flags =IPv4</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">sudo service tftpd-hpa restart</span><br><span class=\"line\">sudo service xinetd restart</span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"自建roofs打包\"><a href=\"#自建roofs打包\" class=\"headerlink\" title=\"自建roofs打包\"></a>自建roofs打包</h1><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd rootfs/</span><br><span class=\"line\">tar -vcjf rootfs.tar.bz2 *</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\">busybox_dir=$HOME/imx6ull/busybox</span><br><span class=\"line\">kernel_dir=$HOME/imx6ull/kernel</span><br><span class=\"line\">gcc_lib_root=/opt/gcc-linaro-4.9.4-2017.01-x86_64_arm-linux-gnueabihf/arm-linux-gnueabihf</span><br><span class=\"line\"></span><br><span class=\"line\">share_dir=$HOME/imx6ull/nfs</span><br><span class=\"line\">rootfs_dir=$share_dir/rootfs</span><br><span class=\"line\"></span><br><span class=\"line\">dtb_file=imx6ull-alientek-emmc.dtb</span><br><span class=\"line\">device_ip=192.168.3.109</span><br><span class=\"line\">netmask=255.255.255.0</span><br><span class=\"line\">gw=192.168.3.1</span><br><span class=\"line\">nfs_server_ip=`ifconfig -a|grep inet|grep -v 127.0.0.1|grep -v inet6|awk &#x27;&#123;print $2&#125;&#x27;|tr -d &quot;addr:&quot;`</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"built_in\">env</span></span></span><br><span class=\"line\">sudo apt update</span><br><span class=\"line\">sudo apt install cmake gcc wget lsb-core lib32stdc++6 libncurses5-dev build-essential lzop -y</span><br><span class=\"line\"></span><br><span class=\"line\">rm $share_dir/* -rf</span><br><span class=\"line\">rm $busybox_dir -rf</span><br><span class=\"line\">rm $kernel_dir -rf</span><br><span class=\"line\">mkdir -p $busybox_dir</span><br><span class=\"line\">mkdir -p $kernel_dir</span><br><span class=\"line\">mkdir -p $rootfs_dir</span><br><span class=\"line\">tar -xvf linux-imx-4.1.15-2.1.0-g3dc0a4b-v2.7.tar.bz2 -C $kernel_dir</span><br><span class=\"line\">tar -xvf busybox-1.29.0.tar.bz2 -C $busybox_dir</span><br><span class=\"line\">mv $busybox_dir/busybox-1.29.0/&#123;.,&#125;* $busybox_dir</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">build</span></span><br><span class=\"line\">cpu_logic_cnt=`cat /proc/cpuinfo | grep &quot;processor&quot; | wc -l`</span><br><span class=\"line\">cd $kernel_dir</span><br><span class=\"line\">make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- distclean</span><br><span class=\"line\">make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- imx_alientek_emmc_defconfig</span><br><span class=\"line\">make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- -j$cpu_logic_cnt</span><br><span class=\"line\">if [ $? -ne 0 ]; then</span><br><span class=\"line\">    exit;</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\">cd $busybox_dir</span><br><span class=\"line\">make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- distclean</span><br><span class=\"line\">wget http://chengs.run/upload/2023/09/busybox_config -O .config</span><br><span class=\"line\">make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- -j$cpu_logic_cnt</span><br><span class=\"line\">if [ $? -ne 0 ]; then</span><br><span class=\"line\">    exit;</span><br><span class=\"line\">fi</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">rootfs</span></span><br><span class=\"line\">cd $busybox_dir</span><br><span class=\"line\">make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- CONFIG_PREFIX=$rootfs_dir install</span><br><span class=\"line\"></span><br><span class=\"line\">cd $rootfs_dir</span><br><span class=\"line\">mkdir lib</span><br><span class=\"line\">mkdir -p usr/lib</span><br><span class=\"line\">mkdir dev</span><br><span class=\"line\">mkdir proc</span><br><span class=\"line\">mkdir mnt</span><br><span class=\"line\">mkdir sys</span><br><span class=\"line\">mkdir tmp</span><br><span class=\"line\">mkdir root</span><br><span class=\"line\">mkdir -p etc/init.d</span><br><span class=\"line\"></span><br><span class=\"line\">echo &quot;#!/bin/sh</span><br><span class=\"line\">PATH=/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class=\"line\">LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/lib:/usr/lib</span><br><span class=\"line\">runlevel=S </span><br><span class=\"line\">umask 022</span><br><span class=\"line\">export PATH LD_LIBRARY_PATH runlevel</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">网络开机自启动设置</span></span><br><span class=\"line\">ifconfig eth0 up</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">udhcpc -i eth0</span> </span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ifconfig eth0 <span class=\"variable\">$&#123;device_ip&#125;</span> netmask <span class=\"variable\">$&#123;netmask&#125;</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">route add default gw <span class=\"variable\">$&#123;gw&#125;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\">mount -a </span><br><span class=\"line\">mkdir /dev/pts</span><br><span class=\"line\">mount -t devpts devpts /dev/pts</span><br><span class=\"line\"></span><br><span class=\"line\">echo /sbin/mdev &gt; /proc/sys/kernel/hotplug</span><br><span class=\"line\">mdev -s</span><br><span class=\"line\">&quot; &gt; etc/init.d/rcS</span><br><span class=\"line\"></span><br><span class=\"line\">chmod 777 etc/init.d/rcS</span><br><span class=\"line\"></span><br><span class=\"line\">echo &quot;#&lt;file system&gt; &lt;mount point&gt; &lt;type&gt; &lt;options&gt; &lt;dump&gt; &lt;pass&gt; </span><br><span class=\"line\">proc /proc proc defaults 0 0 </span><br><span class=\"line\">tmpfs /tmp tmpfs defaults 0 0 </span><br><span class=\"line\">sysfs /sys sysfs defaults 0 0</span><br><span class=\"line\">&quot; &gt; etc/fstab</span><br><span class=\"line\"></span><br><span class=\"line\">echo &quot;#etc/inittab</span><br><span class=\"line\">::sysinit:/etc/init.d/rcS</span><br><span class=\"line\">console::askfirst:-/bin/sh</span><br><span class=\"line\">::restart:/sbin/init</span><br><span class=\"line\">::ctrlaltdel:/sbin/reboot</span><br><span class=\"line\">::shutdown:/bin/umount -a -r 7 ::shutdown:/sbin/swapoff -a</span><br><span class=\"line\">&quot; &gt; etc/inittab</span><br><span class=\"line\"></span><br><span class=\"line\">echo &quot;nameserver 8.8.8.8</span><br><span class=\"line\">nameserver $&#123;gw&#125;</span><br><span class=\"line\">&quot; &gt; etc/resolv.conf</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">rootfs lib</span></span><br><span class=\"line\">cd $gcc_lib_root/libc/lib</span><br><span class=\"line\">cp *so* *.a $rootfs_dir/lib/ -d</span><br><span class=\"line\">rm $rootfs_dir/lib/ld-linux-armhf.so.3</span><br><span class=\"line\">cp ld-linux-armhf.so.3 $rootfs_dir/lib/</span><br><span class=\"line\"></span><br><span class=\"line\">cd $gcc_lib_root/lib</span><br><span class=\"line\">cp *so* *.a $rootfs_dir/lib/ -d</span><br><span class=\"line\"></span><br><span class=\"line\">cd $gcc_lib_root/libc/usr/lib</span><br><span class=\"line\">cp *so* *.a $rootfs_dir/usr/lib/ -d</span><br><span class=\"line\"></span><br><span class=\"line\">cd $rootfs_dir</span><br><span class=\"line\">du ./lib ./usr/lib/ -sh</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">lib <span class=\"built_in\">test</span></span></span><br><span class=\"line\">echo &#x27;&#x27;&#x27;</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">include &lt;stdio.h&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, const char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">   printf(&quot;helloworld\\n&quot;);</span><br><span class=\"line\">   return 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#x27;&#x27;&#x27; &gt;&gt; main.c</span><br><span class=\"line\"></span><br><span class=\"line\">arm-linux-gnueabihf-gcc -o main main.c</span><br><span class=\"line\">mv main $rootfs_dir/root</span><br><span class=\"line\">rm main.c</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">zImage dtb</span></span><br><span class=\"line\">cp $kernel_dir/arch/arm/boot/zImage $share_dir</span><br><span class=\"line\">cp $kernel_dir/arch/arm/boot/dts/$dtb_file $share_dir</span><br><span class=\"line\"></span><br><span class=\"line\">echo &quot;</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">uboot setting</span></span><br><span class=\"line\">setenv bootcmd &#x27;nfs 80800000 $&#123;nfs_server_ip&#125;:$&#123;share_dir&#125;/zImage;nfs 83000000 $&#123;nfs_server_ip&#125;:$&#123;share_dir&#125;/$&#123;dtb_file&#125;;setenv bootargs console=ttymxc0,115200 root=/dev/nfs nfsroot=$&#123;nfs_server_ip&#125;:$&#123;rootfs_dir&#125;,proto=tcp rw ip=$&#123;device_ip&#125;:$&#123;nfs_server_ip&#125;:$&#123;gw&#125;:$&#123;netmask&#125;::eth0:off;bootz 80800000 - 83000000;&#x27;</span><br><span class=\"line\">&quot;</span><br></pre></td></tr></table></figure>","path":"2023/02/24/BusyBox自建根文件系统完善/","permalink":"http://chengs.run/2023/02/24/BusyBox%E8%87%AA%E5%BB%BA%E6%A0%B9%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AE%8C%E5%96%84/","tags":[{"name":"linux","_id":"cm833960c0002i0q66dwgd8wg","slug":"linux","path":"tags/linux/","permalink":"http://chengs.run/tags/linux/","length":13}],"categories":[],"prev":{"title":"linux驱动开发(1)","date":"2023-02-24T06:39:00.931Z","slug":"linux驱动开发(1)","published":true,"updated":"2023-02-24T06:39:00.931Z","_id":"cm833960t0012i0q62bqc6p4r","layout":"post","photos":[],"excerpt":"<p>字符设备驱动开发基础</p>","path":"2023/02/24/linux驱动开发(1)/","permalink":"http://chengs.run/2023/02/24/linux%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91(1)/","__post":true},"next":{"title":"自建KMS服务器","date":"2022-10-22T03:02:20.142Z","slug":"自建KMS服务器","published":true,"updated":"2022-10-22T03:06:10.650Z","_id":"cm8339613001zi0q6hcypdf00","layout":"post","photos":[],"excerpt":"<p>window激活</p>","path":"2022/10/22/自建KMS服务器/","permalink":"http://chengs.run/2022/10/22/%E8%87%AA%E5%BB%BAKMS%E6%9C%8D%E5%8A%A1%E5%99%A8/","__post":true},"__post":true}